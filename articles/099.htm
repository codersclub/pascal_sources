<html><head><title>Формат Bmp-файла - Статьи о Паскале - Pascal.Sources.Ru</title>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
<meta name="description" content='Вторая статья из цикла "Основы спрайтовой анимации". Подробное описание структуры BMP файла и разработка программы считывания изображений (спрайтов, фона и элементов интерфейса) из BMP-файлов.'>
<meta name="keywords" content='pascal, sources, source code, article, sprite, graphics, bmp, графика, спрайты, анимация, игры, Вторая статья из цикла "Основы спрайтовой анимации". Подробное описание структуры BMP файла и разработка программы считывания изображений (спрайтов, фона и элементов интерфейса) из BMP-файлов'>
<LINK REL=STYLESHEET TYPE="text/css" HREF="../sources.css"></head><BODY><center>
<!--#include virtual="/t_hmenu.htm"-->
<div align='left'>&nbsp;&nbsp;&nbsp;<a class='title' href="index.htm">Статьи о Паскале</a>&nbsp&nbsp;&nbsp;&nbsp;<small>&gt;&gt;</small>&nbsp;&nbsp;&nbsp;&nbsp;Формат Bmp-файла
<br>&nbsp;&nbsp;&nbsp;<img border=0 height=4 width=60% align='top' src="../img/b.gif" alt="">
<br>&nbsp;
</div>
<TABLE cellSpacing=0 cellpadding=0 width=97% border=0>
<TR class=subheader><TD colSpan=3><IMG height=2 src="../img/1x1.gif" width=1></td></tr>
<TR><TD class=subheader width=70% nowrap>&nbsp;Формат Bmp-файла</TD>
<TD nowrap class=black>&nbsp;<img border=0 align=bottom src="../img/mail.gif">&nbsp;
Сергей Андрианов
</TD>
<TD class=black align='right'>09.11.2001</TD></TR>
<TR vALign=top><TD class=black><p style="margin-left:20px">
<br>Вторая статья из цикла "Основы спрайтовой анимации".
Подробное описание структуры BMP файла и разработка программы считывания
изображений (спрайтов, фона и элементов интерфейса) из BMP-файлов. 
</TD><TD class=black colspan=2 align='right'><img border=0 align=middle src="../img/more.gif">
<br>16k&nbsp;</TD></TR><TR><TD>&nbsp;</TD></TR>
<TR class=subheader><TD colSpan=3><IMG height=2 src="../img/1x1.gif" width=1></td></tr>
<TR><TD colspan=3>
<div style="margin-left:50px">
<br>
<p>
<b><A href="http://www.osp.ru/pcworld/2001/10/">Мир ПК, #10/2001</a></b>
<br>
Постоянный адрес статьи: <A href="http://www.osp.ru/pcworld/2001/10/099.htm">http://www.osp.ru/pcworld/2001/10/099.htm</a>
<hr size=1>

<h2>Формат Bmp-файла</h2>
Сергей Андрианов
<br>
09.11.2001
<p>
<p>В статье <a href="087.htm">«Основы спрайтовой анимации»</a> была рассмотрена небольшая программа, перемещающая спрайт по экрану, но, к сожалению, он при этом выглядел не так, как хотелось бы. В этой статье мы попробуем «привести» спрайт в порядок.</p>
<p>Изображение спрайта мы получили из Bmp-файла, из таких же файлов можно брать изображение фона, курсора мыши и элементов интерфейса. Однако на экране мы видим не совсем то, что ожидали: изображение оказалось перевернутым и к тому же с иными, нежели требовалось, цветами. Итак, научимся правильно считывать Bmp-файлы и перевернем картинку «с головы на ноги».</p>
<p>По решению разработчиков формат Bmp-файла не привязан к конкретной аппаратной платформе. Этот файл состоит из четырех частей: заголовка, информационного заголовка, таблицы цветов (палитры) и данных изображения. Если в файле хранится изображение с глубиной цвета 24 бита (16 млн. цветов), то таблица цветов может отсутствовать, однако в нашем, 256-цветном случае она есть. Структура каждой из частей файла, хранящего 256-цветное изображение, дана в <a href="#tab1">таблице</a>, а соответствующие типы записей приведены в <a href="#lis1">листинге&nbsp;1</a>.</p>
<p>Заголовок файла начинается с <I>сигнатуры</I> «BM», а затем идет длина файла, выраженная в байтах. Следующие 4 байта зарезервированы для дальнейших расширений формата, а заканчивается этот заголовок <I>смещением</I> от начала файла до записанных в нем данных изображения. При 256 цветах это смещение составляет 1078 — именно столько и пришлось пропустить в нашей прошлой программе, чтобы добраться до данных.</p>
<p>Информационный заголовок начинается с собственной длины (она может изменяться, но для 256-цветного файла составляет 40 байт) и содержит размеры изображения, разрешение, характеристики представления цвета и другие параметры.</p>
<p><I>Ширина и высота изображения</I> задаются в точках растра и пояснений, пожалуй, не требуют.</p>
<p><I>Количество плоскостей</I> могло применяться в файлах, имеющих небольшую глубину цвета. При числе цветов 256 и больше оно всегда равно 1, поэтому сейчас это поле уже можно считать устаревшим, но для совместимости оно сохраняется.</p>
<p><I>Глубина цвета</I> считается важнейшей характеристикой способа представления цвета в файле и измеряется в битах на точку. В данном случае она равна 8.</p>
<p><I>Компрессия. </I>В Bmp-файлах обычно не используется, но поле в заголовке для нее предусмотрено. Обычно она равна 0, и это означает, что изображение не сжато. В дальнейшем будем использовать только такие файлы.</p>
<p><I>Размер изображения</I> — количество байт памяти, требующихся для хранения этого изображения, не считая данных палитры.</p>
<p><I>Горизонтальное и вертикальное разрешения</I> измеряются в точках растра на метр. Они особенно важны для сохранения масштаба отсканированных картинок. Изображения, созданные с помощью графических редакторов, как правило, имеют в этих полях нули.</p>
<p><I>Число цветов</I> позволяет сократить размер таблицы палитры, если в изображении реально присутствует меньше цветов, чем это допускает выбранная глубина цвета. Однако на практике такие файлы почти не встречаются. Если число цветов принимает значение, максимально допустимое глубиной цвета, например 256 цветов при 8 битах, поле обнуляют.</p>
<p><I>Число основных цветов</I> — идет с начала палитры, и его желательно выводить без искажений. Данное поле бывает важно тогда, когда максимальное число цветов дисплея было меньше, чем в палитре Bmp-файла. При разработке формата, очевидно, принималось, что наиболее часто встречающиеся цвета будут располагаться в начале таблицы. Сейчас этого требования практически не придерживаются, т. е. цвета не упорядочиваются по частоте, с которой они встречаются в файле. Это очень важно, поскольку палитры двух разных файлов, даже составленных из одних и тех же цветов, содержали бы их (цвета) в разном порядке, что могло существенно осложнить одновременный вывод таких изображений на экран.</p>
<p>За информационным заголовком следует таблица цветов, представляющая собой массив из 256 (по числу цветов) 4-байтовых полей. Каждое поле соответствует своему цвету в палитре, а три байта из четырех — компонентам синей, зеленой и красной составляющих для этого цвета. Последний, самый старший байт каждого поля зарезервирован и равен 0.</p>
<p>После таблицы цветов находятся данные изображения, которое по строкам растра записано снизу вверх, а внутри строки — слева направо. Так как на некоторых платформах невозможно считать единицу данных, которая меньше 4 байт, длина каждой строки выровнена на границу в 4 байта, т. е. при длине строки, некратной четырем, она дополняется нулями. Это обстоятельство обязательно надо учитывать при считывании файла, хотя, возможно, лучше заранее позаботиться, чтобы горизонтальные размеры всех изображений были кратны 4.</p>
<p>Как мы уже говорили, формат файла был разработан универсальным для различных платформ, поэтому нет ничего удивительного в том, что цвета палитры хранятся в нем иначе, чем принято для VGA. Во время выполнения процедуры чтения производится необходимая перекодировка. (О том, что представляет собой палитра VGA и как с ней работать, мы поговорим в следующих статьях.)</p>
<p>Модуль для чтения 256-цветных Bmp-файлов имеет всего две процедуры. Как видно из листинга, в процедуру чтения файла ReadBMP необходимо передать размеры изображения. Это удобно, если картинку нужно считывать не полностью. Когда заранее известны размеры, это не вызывает проблем, однако было бы хорошо, если бы с помощью нашего модуля можно было читать любые изображения, в том числе и такие, размер которых заранее неизвестен. Для этого предусмотрена процедура ReadBMPheader, считывающая только заголовок файла. Вызвав ее, можно проверить, записано ли изображение в выбранном 256-цветном формате, узнать его размеры и только потом выделять для него память и помещать в отведенный буфер.</p>
<p>Теперь подключим к нашей программе новый модуль. Для этого пропишем его имя в директиве uses, а также предусмотрим массив для хранения данных о палитре, который может быть описан так:</p>
<pre>p: array[0..767]of byte;</pre>
<p>Процедура CreateSprite, вызывающая операцию чтения файла из нового модуля, упростилась (см. <a href="#lis2">листинг&nbsp;2</a>).</p>
<p>Что же изменилось на экране? Спрайт перевернулся, но по-прежнему имеет неестественные цвета. О том, как придать ему первоначальный вид, а также о некоторых возможностях, предоставляемых палитрой, читайте в <a href="100.htm">следующей статье</a>.</p>


<hr size=1>
<a name="tab1">

<h2>Структура Bmp-файла</h2>
<TABLE BORDER=0 WIDTH=90% cellpadding=0 cellspacing=0><tr>
<td bgcolor=#ccccff>
<TABLE BORDER=0 WIDTH=100% cellpadding=4 cellspacing=2>
<tr bgcolor=#ffffff><td><B>Имя</B></td><td><B>Длина</B></td><td><B>Смещение</B></td><td><B>Описание</B></td></tr>
<tr bgcolor=#ffffff><td COLSPAN=4><B>Заголовок файла (BitMapFileHeader)</B></td></tr>
<tr bgcolor=#ffffff><td>Type</td><td>2</td><td> 0</td><td>Сигнатура "BM"</td></tr>
<tr bgcolor=#ffffff><td>Size</td><td>4</td><td> 2</td><td>Размер файла</td></tr>
<tr bgcolor=#ffffff><td>Reserved 1</td><td>2</td><td> 6</td><td>Зарезервировано</td></tr>
<tr bgcolor=#ffffff><td>Reserved 2</td><td>2</td><td> 8</td><td>Зарезервировано</td></tr>
<tr bgcolor=#ffffff><td>OffsetBits</td><td>4</td><td>10</td><td>Смещение изображения от начала файла</td></tr>
<tr bgcolor=#ffffff><td COLSPAN=4><B>Информационный заголовок (BitMapInfoHeader)</B></td></tr>
<tr bgcolor=#ffffff><td>Size</td><td>4</td><td>14</td><td>Длина заголовка</td></tr>
<tr bgcolor=#ffffff><td>Width</td><td>4</td><td>18</td><td>Ширина изображения, точки</td></tr>
<tr bgcolor=#ffffff><td>Height</td><td>4</td><td>22</td><td>Высота изображения, точки</td></tr>
<tr bgcolor=#ffffff><td>Planes</td><td>2</td><td>26</td><td>Число плоскостей</td></tr>
<tr bgcolor=#ffffff><td>BitCount</td><td>2</td><td>28</td><td>Глубина цвета, бит на точку</td></tr>
<tr bgcolor=#ffffff><td>Compression</td><td>4</td><td>30</td><td>Тип компрессии (0 - несжатое изображение)</td></tr>
<tr bgcolor=#ffffff><td>SizeImage</td><td>4</td><td>34</td><td>Размер изображения, байт</td></tr>
<tr bgcolor=#ffffff><td>XpelsPerMeter</td><td>4</td><td>38</td><td>Горизонтальное разрешение, точки на метр</td></tr>
<tr bgcolor=#ffffff><td>YpelsPerMeter</td><td>4</td><td>42</td><td>Вертикальное разрешение, точки на метр</td></tr>
<tr bgcolor=#ffffff><td>ColorsUsed</td><td>4</td><td>46</td><td>Число используемых цветов (0 - максимально возможное для данной глубины цвета)</td></tr>
<tr bgcolor=#ffffff><td>ColorsImportant</td><td>4</td><td>50</td><td>Число основных цветов</td></tr>
<tr bgcolor=#ffffff><td COLSPAN=4><B>Таблица цветов (палитра) (ColorTable)</B></td></tr>
<tr bgcolor=#ffffff><td>ColorTable</td><td>1024</td><td>54</td><td>256 элементов по 4 байта</td></tr>
<tr bgcolor=#ffffff><TD COLSPAN=4><B>Данные изображения (BitMap Array)</B></td></tr>
<tr bgcolor=#ffffff><td>Image</td><td>Size</td><td>1078</td><td>Изображение, записанное по строкам слева направо и снизу вверх</td></tr>
</TABLE>
</td></tr></TABLE>
<br>

<HR SIZE=1 NOSHADE>

<a name="lis1">
<h2>Листинг 1</h2>
<pre>
unit bmpread; {процедуры для работы с Bmp}
interface
type
  artype = array[0..0]of byte;
  arptr = ^artype;
  bmFileHeader = record	{заголовок файла}
    Typf : word;        {сигнатура <BM>}
    Size : longint;     {длина файла в байтах}
    Res1 : word;        {зарезервировано}
    Res2 : word;        {зарезервировано}
    OfBm : longint;     {смещение изображения в байтах (1078)}
  end;
  bmInfoHeader = record   {информационный заголовок}
    Size : longint;       {длина заголовка в байтах (40)}
    Widt : longint;       {ширина изображения (в точках)}
    Heig : longint;       {высота изображения (в точках)}
    Plan : word;          {число плоскостей (1)}
    BitC : word;          {глубина цвета (бит на точку) (8)}
    Comp : longint;       {тип компрессии (0 - нет)}
    SizI : longint;       {размер изображения в байтах}
    XppM : longint;       {горизонтальное разрешение}
 		          {(точек на метр - обычно 0)}
    YppM : longint;       {вертикальное разрешение}
		          {(точек на метр - обычно 0)}
    NCoL : longint;       {число цветов}
		          {(если максимально допустимое - 0)}
    NCoI : longint;       {число основных цветов}
  end;                   
  bmHeader = record       {полный заголовок файла}
    f : bmFileHeader;     {заголовок файла}
    i : bmInfoHeader;     {информационный заголовок}
    p : array[0..255,0..3]of byte; {таблица палитры}
  end;

  bmhptr = ^bmHeader;

{чтение изображения из Bmp-файла}
procedure ReadBMP(image:arptr;      {массив с изображением}
                  xim,yim:word;	    {размеры}
                  pal:arptr;	    {палитра}
                  filename:string); {имя файла}

{чтение заголовка Bmp-файла}
procedure ReadBMPheader(header:bmhptr;filename:string);

implementation

{$R-}

{чтение изображения из Bmp-файла}
procedure ReadBMP(image:arptr; xim,yim:word;
                  pal:arptr; filename:string);
var
  h	  : bmHeader;
  i	  : integer;
  bmpfile : file;
  s	  : longint;
begin
  assign(bmpfile,filename);
  reset(bmpfile,1);
  blockread(bmpfile,h,sizeof(h));   {чтение заголовка}
  for i := 0 to yim-1 do begin	    {построчное чтение}
    blockread(bmpfile,image^[(yim-i-1)*xim],xim);
    if (xim mod 4) &lt;&gt; 0 then
      blockread(bmpfile,s,4 - (xim mod 4));
  end;
  close(bmpfile);
  for i ^= 0 to 255 do begin       {преобразование палитры}
    pal^[i*3+2] := h.p[i,0] shr 2; {синий}
    pal^[i*3+1] := h.p[i,1] shr 2; {зеленый}
    pal^[i*3+0] := h.p[i,2] shr 2; {красный}
  end;
end;

{чтение заголовка Bmp-файла}
procedure ReadBMPheader(header:bmhptr;filename:string);
var
  bmpfile:file;
begin
  assign(bmpfile,filename);
  reset(bmpfile,1);
  blockread(bmpfile,header^,sizeof(header^));
  close(bmpfile);
end;

end.
</pre>

<hr size=1>
<a name="lis2">
<h2>Листинг 2</h2>
<pre>
{<создание> спрайта}
procedure CreateSprite(s:string; x,y,dx,dy:integer);
var
  f : file;	 {файл с изображением спрайта}
begin
  getmem(Sprt.Img,sizeof(SpriteArrayType));
	{выделяем память для спрайта}
  getmem(Sprt.Back,sizeof(SpriteArrayType));
	{выделяем память для буфера}
  Readbmp(@(Sprt.Img^),Xsize,Ysize,@p,s);
  Sprt.x := x;
  Sprt.y := y;	 {задаем начальные значения}
  Sprt.dx := dx; {координат и приращений}
  Sprt.dy := dy;
end;
</pre>

<hr size=1>
<b>
<A href="http://www.osp.ru/pcworld/2001/10/">Мир ПК, #10/2001</a>
</b>
<br>
Постоянный адрес статьи: <A href="http://www.osp.ru/pcworld/2001/10/099.htm">http://www.osp.ru/pcworld/2001/10/099.htm</a>
<br>
<br>

</DIV>
<!--#include virtual="/t_footer.htm"-->
